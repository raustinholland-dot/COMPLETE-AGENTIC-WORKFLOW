# Product Requirements Document
# Clearwater Deal Intelligence Engine

**Version:** 1.0
**Date:** 2026-02-26
**Owner:** Austin Hollins, Clearwater Security & Compliance
**Status:** Active Development — Phase 1 (Ingestion Pipeline) In Progress

---

## 1. Executive Summary

The Clearwater Deal Intelligence Engine is a fully automated RAG (Retrieval-Augmented Generation) AI system built on n8n that transforms raw deal communications into structured, actionable intelligence. The system ingests emails, call transcripts, PDFs, PowerPoints, and other deal artifacts from a dedicated Gmail inbox, embeds them into a Qdrant vector database, and orchestrates a suite of specialized AI agents to continuously analyze, score, and advance active sales opportunities.

At its core, the engine operationalizes Clearwater's proprietary **CPS (Clearwater Performance Selling)** methodology — specifically the **P2V2C2 framework** (Pain, Power, Vision, Value, Change, Control) — by automatically scoring every active deal across all six dimensions after each new ingestion event, plus tracking the Salesforce Critical Activity Stage, DAP (Dual Action Plan) milestones, and 16 additional deal intelligence artifacts. This eliminates the manual Salesforce update burden while generating richer, more consistent deal intelligence than any human process can sustain across 20-25 simultaneous active deals.

The system delivers three categories of value: (1) continuous deal health monitoring with trend analysis, surfaced via a Metabase dashboard; (2) high-quality AI-generated outputs including follow-up emails, pre-call planners, branded PDFs, and executive PowerPoint presentations delivered to the AE's Gmail/Outlook inbox; and (3) an always-available conversational AI that can answer questions about any deal or across the entire pipeline instantly via the n8n chat widget.

**MVP Goal:** A fully operational ingestion pipeline, deal health scoring engine, and output generation agent running on local Docker infrastructure, tested end-to-end against real Clearwater deals.

---

## 2. Mission

**Mission Statement:** Eliminate the gap between what happens in a deal and what the AE knows about it — making every Clearwater salesperson as informed, prepared, and strategic as if they had a dedicated analyst working every deal, every day.

### Core Principles

1. **Methodology-First:** Every AI output is grounded in CPS/P2V2C2. The system speaks Clearwater's language — DAP, PES, Champion, Critical Activity Stage — not generic sales language.
2. **Evidence-Based:** All scores and narratives cite specific documents and dates. No hallucination, no gut feel — only what the deal record actually supports.
3. **Deal Velocity:** Every feature exists to move deals forward faster. Outputs are always actionable, never just informational.
4. **Auditability:** A complete, timestamped record of every ingestion, score, and AI-generated output is preserved in Postgres. Nothing is lost or overwritten.
5. **Human in the Loop:** The system automates the mundane and surfaces the important, but Austin confirms ambiguous deal attributions and approves all outputs before final delivery.

---

## 3. Target Users

### Primary User: Austin Hollins (Clearwater AE)

- **Role:** Account Executive, Clearwater Security & Compliance
- **Industry:** Cybersecurity, risk management, and compliance services for healthcare organizations
- **Technical Comfort:** High — comfortable with Docker, APIs, Claude Code, VS Code
- **Deal Volume:** 20-25 active deals at any time
- **Daily Input Volume:** 10-20 emails, ~2 long call transcripts, multiple team messages
- **Current Pain Points:**
  - Manual Salesforce updates consume significant time and are often stale
  - P2V2C2 scoring requires reviewing all recent deal communications before updating
  - Generating high-quality follow-up emails, pre-call planners, and approach documents is time-intensive
  - No easy way to see deal health trends or compare deals across the pipeline
  - Meeting preparation is inconsistent — no systematic process for agenda creation

### Secondary Users (Future Phases)

- **Sales Manager / VP:** Read-only Metabase dashboard for pipeline visibility
- **Delivery Team:** Access to deal scoping narratives for resource planning
- **Internal Colleagues:** Recipients of deal update emails generated by the system

---

## 4. MVP Scope

### In Scope — Core Functionality

| Feature | Phase | Status |
|---|---|---|
| ✅ Gmail ingestion trigger (dedicated inbox, poll 5 min) | 1 | Built |
| ✅ Multi-format document processing (email, PDF, DOCX, TXT, PPTX, CSV) | 1 | Built |
| ✅ AI deal attribution (company/domain inference + confidence routing) | 1 | Built |
| ✅ Human confirmation queue for low-confidence attributions | 1 | Built |
| ✅ Deduplication by Gmail message_id | 1 | Built |
| ✅ Qdrant vector storage, one namespace per deal | 1 | Built |
| ✅ Contextual enrichment header before chunking | 1 | Built |
| ✅ P2V2C2 scoring (all 6 dimensions, 0-5 each, evidence cited) | 2 | Built |
| ✅ All 22 deal health artifacts (see §7) | 2 | Built |
| ✅ Salesforce Critical Activity Stage detection | 2 | Built |
| ✅ DAP status tracking (14-milestone model, 14-day gap rule) | 2 | Built |
| ✅ Trend analysis (improving/stable/declining) per deal | 2 | Built |
| ✅ Declining deal email alert | 2 | Built |
| ✅ Metabase dashboard (deal health, trends, pipeline summary) | 2 | Built |
| ✅ Output Generation Agent (10 output types) | 3 | In progress |
| ✅ Output history tracking per deal/contact (prevents repetition) | 3 | In progress |
| ✅ Q&A Chat Agent (n8n chat widget) | 4 | Pending |
| ✅ Attribution confirmation via chat | 4 | Pending |
| ✅ Google Calendar sync read + meeting prep emails | 5 | Pending |

### Out of Scope (Future Phases)

| Feature | Phase |
|---|---|
| ❌ Salesforce write integration | 6+ |
| ❌ Salesforce read / data sync | 6+ |
| ❌ Outlook calendar write (live scheduling) | 6 |
| ❌ Colleague availability lookup via Graph API | 6 |
| ❌ Cloud hosting migration (always-on VPS) | Post-MVP |
| ❌ Multi-user access control | Post-MVP |
| ❌ Slack / Teams integration | Future |
| ❌ Automated Calendly scheduling | Future |
| ❌ Mobile interface | Future |

---

## 5. User Stories

### US-01: Automated Deal Ingestion
**As Austin,** I want every email, call transcript, and document I forward to the ingestion inbox to be automatically parsed and added to the correct deal's knowledge base, **so that** I never have to manually copy-paste deal notes into any system.

*Example: I finish a 45-minute discovery call with Acme Health, forward the Otter.ai transcript to `deals-intel@gmail.com`, and within 10 minutes that transcript is chunked, embedded, and queryable — and the deal's P2V2C2 scores have been automatically updated.*

---

### US-02: Automatic P2V2C2 Scoring
**As Austin,** I want the system to automatically re-score every P2V2C2 dimension after each new ingestion, **so that** my Salesforce updates take 2 minutes instead of 20 and are always grounded in actual evidence with citations.

*Example: After a call where the CFO agreed to financial terms, the system bumps Value from 3 to 5 and cites "Call transcript, Feb 14 — 'We've reviewed the ROI model and finance has signed off on the investment level.'"*

---

### US-03: Deal Health Dashboard
**As Austin,** I want a visual dashboard showing all active deals with current P2V2C2 scores, stage, trend, and risk flags, **so that** I can prioritize my week on the deals most at risk or most ready to advance.

*Example: Monday morning I open Metabase, see two deals are declining (red), four are stable (yellow), three are improving (green). I immediately know where to focus.*

---

### US-04: High-Quality Follow-Up Emails
**As Austin,** I want to ask the AI to draft a follow-up email for a specific deal contact, **so that** I can send a thoughtful, deal-specific email in 5 minutes instead of 30.

*Example: "Draft a follow-up to John Smith at Acme Health after our call yesterday confirming next steps and proposing times for the co-creation session." The agent retrieves call content from Qdrant, references the specific pain points discussed, and sends the draft to my Gmail.*

---

### US-05: Pre-Call Planner
**As Austin,** I want an AI-generated pre-call planner before any important meeting, **so that** I walk into every call fully prepared with CPS-aligned talking points, deal context, and open questions.

*Example: The night before a Prove-stage presentation, I request a pre-call planner. It retrieves latest health scores, drafts an agenda aligned to Critical Activity 3B, lists all attendees with roles, and identifies the top 3 risks to address.*

---

### US-06: Deal Q&A
**As Austin,** I want to ask natural language questions about any deal or across my entire pipeline, **so that** I can get instant answers without digging through emails or Salesforce.

*Example: "What did the CISO at Acme Health say about their current risk analysis program?" or "Which of my deals are stuck in Qualify with a Power score below 3?"*

---

### US-07: Approach Document Generation
**As Austin,** I want the system to generate a branded Clearwater Approach Document PDF for a deal, **so that** I can produce a professional client-ready deliverable in minutes instead of hours.

*Example: "Generate an Approach Document for Acme Health." The agent retrieves current state, future state, success criteria, and proposed services from Qdrant, formats them into the Clearwater template, and emails the PDF to my inbox.*

---

### US-08: Output Memory
**As Austin,** I want the system to remember every email and document it has already generated and sent for each deal and contact, **so that** follow-up emails don't repeat themselves and always build on prior communications.

*Example: When drafting a second follow-up to John Smith, the agent automatically retrieves the first follow-up it sent and writes something that progresses the conversation rather than repeating the same talking points.*

---

## 6. Core Architecture & Patterns

### High-Level Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Docker Compose Stack                      │
│                                                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────────┐  │
│  │   n8n    │  │  Qdrant  │  │ Postgres │  │   Redis    │  │
│  │  :5678   │  │  :6333   │  │  :5432   │  │   :6379    │  │
│  └──────────┘  └──────────┘  └──────────┘  └────────────┘  │
│                                                              │
│  ┌──────────┐                                               │
│  │Metabase  │                                               │
│  │  :3000   │                                               │
│  └──────────┘                                               │
└─────────────────────────────────────────────────────────────┘

External APIs:
  Gmail API (v1)         → Ingestion trigger + output delivery
  OpenAI API             → text-embedding-3-small (1536 dims)
  Anthropic API          → Claude Sonnet 4.6 + Opus 4.6
  Google Calendar API v3 → Phase 5 calendar read
  GitHub MCP Server      → Version control via Claude Code
  n8n-mcp (czlonkowski)  → Claude Code → n8n workflow authoring
```

### Directory Structure

```
deal-intelligence-engine/
├── docker-compose.yml              # All 5 services
├── .env.example                    # Template (no secrets)
├── .env                            # Local secrets (gitignored)
├── .gitignore
├── n8n/
│   ├── workflows/
│   │   ├── workflow-01-ingestion.json      # Phase 1 ✅
│   │   ├── workflow-02-deal-health.json    # Phase 2 ✅
│   │   ├── workflow-03-output-gen.json     # Phase 3
│   │   └── workflow-04-chat-agent.json     # Phase 4
│   └── credentials/                # Credential stubs (no secrets)
├── postgres/
│   └── init/
│       └── 01_schema.sql           # Full DB schema + views
├── qdrant/
│   └── config.yaml                 # Qdrant HNSW + quantization config
├── templates/
│   ├── pdf/                        # Jinja2 HTML → PDF templates
│   └── pptx/                       # Branded Clearwater .pptx base files
└── scripts/
    ├── setup.sh                    # First-run setup
    └── create-qdrant-collection.sh # Qdrant collection init
```

### Key Design Patterns

1. **Ingestion/Retrieval Separation:** Two completely independent workflow chains. Ingestion is async/batch; retrieval is synchronous/real-time. Never mixed.
2. **Namespace-per-Deal Isolation:** Every deal gets its own Qdrant namespace (`deal_id`). Queries are always namespace-scoped — no cross-contamination.
3. **Contextual Enrichment:** Every chunk is prepended with a `[DEAL CONTEXT]` header before embedding (Anthropic Contextual Retrieval pattern). Dramatically improves retrieval precision.
4. **Idempotent Ingestion:** Gmail `message_id` is the deduplication key. Re-forwarding the same email is a no-op.
5. **Evidence-Only Scoring:** Claude Opus scores all P2V2C2 dimensions strictly from retrieved evidence. If no evidence exists, score = 0. No interpolation.
6. **Append-Only Health History:** `deal_health` table never updates existing rows — always inserts. Complete audit trail of every score over time.
7. **Output Memory:** Every AI-generated output is logged to `outputs_log` with recipient, content summary, and full text. Output agents always retrieve this history before generating new content.

---

## 7. Workflow Features

### Workflow 1: Ingestion Pipeline

```
Gmail Trigger (poll 5 min, dedicated inbox)
  → Gmail: Get Full Message (Simplify=OFF, Attachments=ON)
  → Dedup check: message_id already in Postgres? → skip
  → AI Classifier (Claude Sonnet): company, doc_type, confidence
  → Confidence Router: high/medium → auto-assign | low → attribution queue
  → Deal Lookup: match sender domain / company name to deals table
  → Deal ID Assignment: confirmed deal_id or generate new slug
  → Doc Type Router: email body / file extract / transcript
  → Contextual Enrichment: prepend [DEAL CONTEXT] header
  → Recursive Text Splitter (500 tokens, 50 overlap)
  → OpenAI Embeddings (text-embedding-3-small)
  → Qdrant Insert (collection: deals, namespace: deal_id)
  → Postgres: log to ingestion_log
  → HTTP POST: trigger Workflow 2 for this deal_id
```

### Workflow 2: Deal Health Agent

**Triggers:** Webhook from Workflow 1 (after every ingestion) + Nightly schedule (8pm ET, weekdays)

**22 Tracked Artifacts:**

| # | Artifact | Postgres Column(s) |
|---|---|---|
| 1 | Account | `deals.company_name` |
| 2 | Date | `deal_health.scored_at` |
| 3 | Input Type | via `ingestion_log.doc_type` |
| 4 | Salesforce Stage / CAS | `salesforce_stage`, `critical_activity_stage` |
| 5 | Close Date | `close_date` |
| 6 | Forecast Category | `forecast_category` |
| 7 | P2V2C2 Scores | `pain_score` … `control_score` + justifications + evidence sources |
| 8 | PE Sponsor Score (1-5) | `pe_sponsor_score` + `pe_sponsor_justification` |
| 9 | DAP Block | `dap_exists`, `dap_agreed`, `milestones_complete`, `has_14_day_gap`, `next_milestone`, `next_milestone_date` |
| 10 | Current State | `current_state_org`, `current_state_activities`, `current_state_technology` |
| 11 | Future State | `future_state_org`, `future_state_activities`, `future_state_technology` |
| 12 | Key Stakeholder Success Criteria | `key_stakeholder_success_criteria` |
| 13 | Risks | `risks[]` |
| 14 | Next Step + Date | `next_step`, `next_step_date` |
| 15 | Call Summary | `call_summary` |
| 16 | Highlights | `highlights[]` |
| 17 | Action Items (Prospect) | `action_items_prospect[]` |
| 18 | Action Items (Internal) | `action_items_internal[]` |
| 19 | Internal Actions | `internal_actions[]` |
| 20 | Services Narrative | `services_narrative` |
| 21 | General Narrative | `general_narrative` |
| 22 | Internal Team Update | `internal_team_update` (2 paragraphs, no bullets, PE air cover) |

**RAG Strategy:** 15 targeted queries run per scoring event — one per CPS dimension plus DAP, current state, future state, stakeholders, risks, next steps, and services. Each query uses Clearwater-specific language (DAP, PES, ES, Champion).

### Workflow 3: Output Generation Agent

**Supported Output Types:**

| Output | Trigger | Delivery |
|---|---|---|
| Follow-up email (external) | Chat request | Gmail → Austin's Outlook |
| Reminder / next-step confirm | Chat request | Gmail → Austin's Outlook |
| Meeting time proposal | Chat request | Gmail → Austin's Outlook |
| Circle-back email | Chat request | Gmail → Austin's Outlook |
| Scoping info request | Chat request | Gmail → Austin's Outlook |
| Pre-call planner | Chat request or calendar sync | Gmail → Austin's Outlook |
| Internal deal update | Chat request | Gmail → Austin's Outlook |
| Pricing/scoping to colleagues | Chat request | Gmail → Austin's Outlook |
| Approach Document PDF | Chat request | Gmail attachment → Austin's Outlook |
| Executive PowerPoint | Chat request | Gmail attachment → Austin's Outlook |

**Output Memory Pattern:** Before generating any output, the agent queries `outputs_log` for all prior outputs to the same `recipient_email` for the same `deal_id`. This history is injected into the Claude prompt so every new output acknowledges and builds on prior communications.

**LLM Strategy:** Claude Sonnet 4.6 for email drafts and internal content; Claude Opus 4.6 for Approach Document PDFs and executive-level presentations.

### Workflow 4: Q&A Chat Agent

- **Interface:** n8n built-in chat widget
- **Scope:** Auto-detects deal-specific vs. cross-deal query from context
- **Tools:** Qdrant Vector Store Tool (deal-filtered or full), Postgres Tool (health scores, DAP, output history), Attribution Queue Tool (pending confirmations)
- **Memory:** Redis (active session, 24h TTL) + Postgres permanent history keyed by `deal_id`
- **Confirmation UX:** Pending low-confidence attributions surface directly in chat conversation

---

## 8. Technology Stack

### Infrastructure

| Service | Image | Version | Port |
|---|---|---|---|
| n8n | `n8nio/n8n` | 2.8.3 | 5678 |
| Qdrant | `qdrant/qdrant` | 1.13.0 | 6333 |
| PostgreSQL | `postgres` | 16-alpine | 5432 |
| Redis | `redis` | 7-alpine | 6379 |
| Metabase | `metabase/metabase` | 0.51.5 | 3000 |

### AI / ML

| Component | Technology | Config |
|---|---|---|
| Embeddings | OpenAI `text-embedding-3-small` | 1536 dims, $0.02/1M tokens |
| Classification + Q&A | Claude Sonnet 4.6 | Fast, cost-effective |
| Deal Health Scoring | Claude Opus 4.6 | Maximum accuracy, all 22 artifacts |
| High-Stakes Outputs | Claude Opus 4.6 | Approach Docs, exec PPTs |
| Standard Outputs | Claude Sonnet 4.6 | Follow-up emails, planners |
| Chunking | Recursive Character Splitter | 500 tokens, 50 overlap |

### Integrations

| Integration | Protocol | Scope |
|---|---|---|
| Gmail (ingestion) | Gmail API v1 | OAuth2 — read unread, download attachments |
| Gmail (send) | Gmail API v1 | OAuth2 — send emails |
| Google Calendar | Google Calendar API v3 | OAuth2 — read-only (Phase 5) |
| Salesforce | REST API v59 | OAuth2 — write-only (Phase 6+) |
| GitHub | GitHub MCP Server `@modelcontextprotocol/server-github` | PAT |
| Claude Code ↔ n8n | `czlonkowski/n8n-mcp` | n8n API Key |

### Development Tooling

| Tool | Purpose |
|---|---|
| Claude Code | Primary development environment (this session) |
| `czlonkowski/n8n-mcp` | Claude Code → n8n workflow creation/management |
| `czlonkowski/n8n-skills` | Improves Claude's n8n workflow generation quality |
| `EtienneLescot/n8n-as-code` | VS Code ↔ n8n bidirectional sync |
| GitHub MCP Server | Claude Code commits workflow JSON on approval |

---

## 9. Security & Configuration

### Environment Variables

All secrets in `.env` (gitignored). Template at `.env.example`.

```bash
# n8n
N8N_ENCRYPTION_KEY=        # 32-char random string
WEBHOOK_URL=               # http://localhost:5678/

# Database
POSTGRES_PASSWORD=         # Strong password

# Redis
REDIS_PASSWORD=            # Redis auth

# AI APIs
OPENAI_API_KEY=            # sk-...
ANTHROPIC_API_KEY=         # sk-ant-...

# Gmail OAuth2 (ingestion inbox)
GMAIL_CLIENT_ID=
GMAIL_CLIENT_SECRET=
GMAIL_INGESTION_ADDRESS=   # Dedicated deal ingestion Gmail address

# Gmail OAuth2 (send outputs)
GMAIL_SEND_CLIENT_ID=
GMAIL_SEND_CLIENT_SECRET=

# Google Calendar
GOOGLE_CALENDAR_CLIENT_ID=
GOOGLE_CALENDAR_CLIENT_SECRET=

# Delivery
AUSTIN_EMAIL=              # austin@clearwaterits.com (Outlook receives Gmail-sent emails)

# GitHub
GITHUB_TOKEN=              # ghp_...
GITHUB_REPO=               # username/repo
```

### Security Design

- All 5 Docker services on isolated `clearwater-net` bridge network
- Qdrant namespace-per-deal: agent queries are physically scoped to one deal's data
- Deduplication prevents ingestion re-processing (idempotent by design)
- Boilerplate stripping before chunking mitigates prompt injection from email content
- `.env` and all credential files are gitignored

### Out of Scope (MVP Security)

- TLS between internal Docker services
- n8n UI authentication (local single-user)
- Formal security audit
- GDPR/HIPAA compliance controls (sales data only, not patient data)

---

## 10. Database Schema (Key Tables)

```sql
deals                  -- Master deal registry, SF opportunity IDs, sender domains
ingestion_log          -- Every processed email: message_id, deal_id, doc_type, status
deal_health            -- Append-only P2V2C2 scores + all 22 artifacts, timestamped
outputs_log            -- Every AI-generated output per deal/contact (full content + summary)
attribution_queue      -- Low-confidence attributions awaiting Austin's confirmation
calendar_events        -- Phase 5: Google Calendar mirror, linked to deals
n8n_chat_histories     -- Persistent agent conversation memory (Postgres Chat Memory)

-- Views (for Metabase)
v_deal_health_latest   -- Latest score per deal (DISTINCT ON deal_id)
v_deal_health_trend    -- 30-day scoring history per deal
v_pipeline_summary     -- Stage + forecast distribution with avg P2V2C2
```

---

## 11. Success Criteria

### MVP Success Definition

The MVP is successful when Austin can forward a deal email to the ingestion inbox and within 15 minutes receive an updated P2V2C2 score with evidence citations — then request a draft follow-up email that references specific content from that same communication.

### Functional Requirements

- ✅ Ingestion pipeline handles email bodies, PDFs, TXT, PPTX, CSV without manual intervention
- ✅ Deduplication: same email forwarded twice → one record only
- ✅ Deal attribution accuracy ≥ 85% for emails from known sender domains
- ✅ Low-confidence attributions surfaced for confirmation in chat widget
- ✅ P2V2C2 scores generated within 3 minutes of ingestion trigger
- ✅ All 22 deal health artifacts populated for each scoring run
- ✅ Score evidence always cites specific document type and date
- ✅ Salesforce Critical Activity Stage detected and tracked
- ✅ DAP 14-day gap rule enforced and flagged
- ✅ Deal health history queryable by deal and date range in Metabase
- ✅ Declining deal alert email sent when score is below 12/30 and trending down
- ✅ Output generation produces send-ready emails requiring ≤ 10 min editing
- ✅ Output history prevents repeating content to same contact
- ✅ All outputs delivered to Austin's Gmail/Outlook inbox
- ✅ Chat agent answers deal questions with < 10 second response time

### Quality Indicators

- P2V2C2 AI scores agree with Austin's manual assessment within 1 point per dimension ≥ 80% of the time
- Zero data loss: every ingested document recoverable from Qdrant + Postgres log
- System uptime ≥ 95% during business hours on local Docker
- Follow-up emails require ≤ 10 minutes of editing before Austin sends

---

## 12. Implementation Phases

### Phase 1: Ingestion Pipeline ✅ (Weeks 1-2)
**Goal:** Everything that enters the dedicated Gmail inbox is automatically stored, classified, and searchable.

**Deliverables:**
- ✅ `docker-compose.yml` (n8n, Qdrant, Postgres, Redis, Metabase)
- ✅ `.env.example` with all required variables documented
- ✅ `postgres/init/01_schema.sql` — full schema with tables and Metabase views
- ✅ `qdrant/config.yaml` — HNSW index + scalar quantization
- ✅ `workflow-01-ingestion.json` — Gmail → Qdrant full pipeline
- ✅ Gmail OAuth2 credentials configured in n8n
- ✅ Qdrant `deals` collection created with payload schema
- ✅ End-to-end test: forward real deal email → verify chunks in Qdrant

**Validation:** Query Qdrant for a phrase from a real ingested call transcript and retrieve the correct chunk with deal metadata.

---

### Phase 2: Deal Health Agent ✅ (Weeks 3-4)
**Goal:** Every active deal has a live P2V2C2 score with all 22 artifacts, auto-updating after every ingestion.

**Deliverables:**
- ✅ `workflow-02-deal-health.json` — full scoring engine
- ✅ All 22 artifacts stored in `deal_health` table
- ✅ Nightly rescore schedule (8pm ET, weekdays)
- ✅ Declining deal email alert
- ✅ Metabase connected to Postgres with 3 base dashboards
- ✅ Critical Activity Stage detection
- ✅ DAP 14-day gap rule

**Validation:** Score a real deal with Austin's manual P2V2C2 assessment — verify ≥ 80% agreement within 1 point per dimension.

---

### Phase 3: Output Generation Agent (Weeks 5-6)
**Goal:** Austin can request any of 10 output types and receive a send-ready draft in his inbox within 3 minutes.

**Deliverables:**
- ✅ `workflow-03-output-gen.json` — full output generation pipeline
- ✅ `outputs_log` table tracking all generated outputs
- ✅ Output memory: prior outputs retrieved before generation
- ✅ All 8 email output types
- ✅ Branded Clearwater PDF (Approach Document via Jinja2 + WeasyPrint)
- ✅ Branded Clearwater PPTX (Executive Presentation via python-pptx)
- ✅ Gmail delivery to Austin's Outlook inbox

**Validation:** Request follow-up email twice for same contact — verify second email builds on and references first without repetition.

---

### Phase 4: Q&A Chat Agent (Weeks 7-8)
**Goal:** Austin has a fully functional deal intelligence assistant via the n8n chat widget.

**Deliverables:**
- ✅ `workflow-04-chat-agent.json`
- ✅ n8n chat widget configured and accessible
- ✅ Deal-scoped queries (namespace-filtered Qdrant)
- ✅ Cross-deal pipeline queries
- ✅ Attribution confirmation queue surfaced in chat
- ✅ Redis active-session memory (24h TTL)
- ✅ Postgres permanent conversation history

**Validation:** 10 test questions across 3 deals — all answers grounded in actual deal content.

---

### Phase 5: Scheduling Agent v1 (Weeks 9-10)
**Goal:** System reads Austin's Google Calendar, links events to deals, and auto-generates meeting prep emails 24h in advance.

**Deliverables:**
- ✅ Google Calendar API integration (read-only)
- ✅ `calendar_events` table populated with upcoming meetings
- ✅ Deal-to-meeting linkage (AI infers from attendee domains)
- ✅ Pre-meeting prep email: agenda + CPS-aligned talking points + participants + deal context
- ✅ Automatic delivery 24h before any deal-related meeting

---

## 13. Future Considerations

### Phase 6: Salesforce Write Integration
- Write P2V2C2 scores to Salesforce Opportunity custom fields automatically after each scoring run
- Update `Next_Step__c` and `Next_Step_Date__c` from `deal_health.next_step`
- Create Salesforce Activity records for each ingested call transcript
- Trigger Salesforce workflow rules on CAS stage transitions

### Phase 7: Advanced Scheduling (Outlook)
- Outlook calendar write via Microsoft Graph API
- Colleague availability lookup via Graph API free/busy endpoint
- Propose and book meeting times without manual AE intervention

### Phase 8: Cloud Migration
- Migrate Docker Compose to a $20-40/month Linux VPS (Hetzner, DigitalOcean, or Linode)
- Always-on operation independent of Austin's laptop
- Configure n8n webhook URL for cloud domain
- Automated Postgres + Qdrant backups to S3/Backblaze

### Phase 9: Team Access
- Multi-user n8n authentication and Metabase access controls
- Deal-level access control (AE sees only their deals)
- Sales manager aggregate pipeline dashboard

### Advanced RAG Enhancements
- Hybrid search (BM25 + vector via Qdrant sparse vectors + DBSF fusion)
- Parent-child chunking for long transcripts
- Cross-deal pattern analysis: "Find won deals most similar to this one"
- Automatic competitive intelligence extraction across all deals

---

## 14. Risks & Mitigations

| Risk | Probability | Impact | Mitigation |
|---|---|---|---|
| **Gmail OAuth token expiry** breaks ingestion silently | Medium | High | n8n error workflow sends alert email to Austin; implement token refresh monitoring node |
| **Wrong deal attribution** causes deal data contamination | Medium | High | Namespace-per-deal contains blast radius to one deal; low-confidence queue catches ambiguous cases; easy re-attribution via chat |
| **Claude Opus cost on high-volume days** (many simultaneous rescores) | Low | Medium | 30-min cooldown: don't re-score same deal within 30 min of prior scoring run |
| **Local Docker down** (laptop sleep/restart) stops ingestion | High | Medium | Acceptable for MVP (Phase 8 cloud migration resolves); Docker `restart: unless-stopped` policy handles restarts |
| **Large attachment (>20MB PDF/PPTX)** causes memory error | Low | Low | File size filter at ingestion (skip >20MB, log warning); `N8N_DEFAULT_BINARY_DATA_MODE=filesystem` prevents in-memory blowup |

---

## 15. Appendix

### Related Files

| File | Purpose |
|---|---|
| `2024 CPS Refresher Training.pdf` | Clearwater Performance Selling methodology (full P2V2C2 scoring rubrics) |
| `Clearwater Company and Services Overview 24JUNE25 copy.pdf` | Services portfolio — used in output generation system prompt |
| `.claude/memory/MEMORY.md` | Persistent AI session memory for this build |
| `deal-intelligence-engine/docker-compose.yml` | All 5 Docker services |
| `deal-intelligence-engine/postgres/init/01_schema.sql` | Complete Postgres schema |

### CPS P2V2C2 Quick Reference

**6 Dimensions (0-5 each, max total = 30):**

| Dimension | Score 0 | Score 5 |
|---|---|---|
| Pain | No knowledge of pain | ES agreed pain large enough to change |
| Power | No idea who is power | DAP steps on schedule |
| Vision | No idea of needs | ES painting vision to others in org |
| Value | Benefits unknown | DM agreed to financial terms |
| Change | No one committed | ES convinced DM they must change |
| Control | Buying process unknown | DAP complete |

**5 Sales Stages:** Discover → Qualify → Prove → Negotiate → Close

**Key Roles:** PC (Potential Champion), C (Champion), PES (Potential Executive Sponsor), ES (Executive Sponsor), DM (Ultimate Decision Maker)

**DAP:** Dual Action Plan — joint project plan with client, dates + owners for all steps to close.

### Key Tool URLs

| Tool | URL |
|---|---|
| n8n Docs | https://docs.n8n.io/advanced-ai/rag-in-n8n/ |
| Qdrant n8n Platform Page | https://qdrant.tech/documentation/platforms/n8n/ |
| czlonkowski/n8n-mcp | https://github.com/czlonkowski/n8n-mcp |
| czlonkowski/n8n-skills | https://github.com/czlonkowski/n8n-skills |
| n8n-as-code | https://github.com/EtienneLescot/n8n-as-code |
